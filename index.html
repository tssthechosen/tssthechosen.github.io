<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>d3m3t3r • Greenhouse Live</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://cdn.jsdelivr.net/npm/@picocss/pico@1.5.10/css/pico.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --card-bg: rgba(255,255,255,0.02);
      --muted: #a2a8b3;
      --up: #2dd4bf;
      --down: #f43f5e;
      --brand: #22c55e;
    }
    body { background: #0b1220; }
    header { margin-block: 1rem 0.2rem; }
    .chip { font-size: .75rem; padding: .25rem .6rem; border-radius: 999px; background: var(--card-bg); border: 1px solid rgba(255,255,255,.06);}
    .chip.success { color: #10b981; border-color: rgba(16,185,129,.3); }
    .chip.danger { color: #f43f5e; border-color: rgba(244,63,94,.3); }
    .panel { background: var(--card-bg); border: 1px solid rgba(255,255,255,.06); border-radius: .8rem; padding: 1rem; }
    .grid-3 { display: grid; gap: 1rem; grid-template-columns: repeat(3,minmax(0,1fr)); }
    .grid-2 { display: grid; gap: 1rem; grid-template-columns: repeat(2,minmax(0,1fr)); }
    .grid-1 { display: grid; gap: 1rem; grid-template-columns: 1fr; }
    @media (max-width: 1024px){ .grid-3 { grid-template-columns: 1fr; } .grid-2 { grid-template-columns: 1fr; } }
    .kpi { display:flex; align-items: baseline; gap:.5rem; }
    .kpi .value { font-size: 2.2rem; font-weight: 700; letter-spacing: -.02em; }
    .kpi small { color: var(--muted); }
    .spark { height: 140px; }
    .muted { color: var(--muted); }
    .owner-row { display: grid; gap:.75rem; grid-template-columns: 1.5fr 1fr 1.5fr auto auto; align-items: end; }
    .owner-row input { margin:0; }
    .table-wrap { overflow:auto; max-height: 520px; }
    .right { text-align: right; }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
    .brand { color: var(--brand); font-weight: 700; }
    .badge { font-size:.7rem; padding:.15rem .45rem; border-radius:.45rem; border:1px solid rgba(255,255,255,.08) }
    .btn-ghost { background: transparent; border:1px solid rgba(255,255,255,.08); }
  </style>
</head>
<body>
  <main class="container">
    <header>
      <hgroup>
        <h2 class="brand">d3m3t3r</h2>
        <p class="muted">Areka greenhouse telemetry — privacy-first, owner-controlled.</p>
      </hgroup>
    </header>

    <section class="panel">
      <div style="display:flex;justify-content:space-between;gap:.75rem;align-items:center;flex-wrap: wrap;">
        <h3 style="margin:.25rem 0;">Greenhouse • Live</h3>
        <div style="display:flex;gap:.5rem;align-items:center;">
          <span id="statusChip" class="chip">offline</span>
          <button id="ownerToggle" class="chip btn-ghost" type="button" aria-label="Owner">⚙ Owner</button>
        </div>
      </div>
      <p class="muted" id="deviceLine">Device <strong class="mono" id="deviceIdText">—</strong>. Pulls securely from Azure Functions (key stays in your browser).</p>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin:.25rem 0 1rem;">
        <button id="btnRefresh" class="secondary">Refresh</button>
        <span class="badge" id="syncBadge">error – Failed to fetch</span>
        <button id="btnAuto" class="btn-ghost">Auto-refresh 30s</button>
      </div>

      <!-- Owner panel -->
      <div id="ownerPanel" class="panel" style="display:none;margin-top:.75rem;">
        <div class="owner-row">
          <div>
            <label for="host">Cloud Host</label>
            <input id="host" type="url" placeholder="https://YOUR-FUNCTIONS.azurewebsites.net" />
          </div>
          <div>
            <label for="deviceId">Device Id</label>
            <input id="deviceId" type="text" placeholder="pi5-greenhouse-01" />
          </div>
          <div>
            <label for="fnKey">Function Key (stored only in this browser)</label>
            <input id="fnKey" type="password" autocomplete="off" placeholder="default function key" />
          </div>
          <div><button id="btnSave" class="secondary" style="margin-top:1.7rem;">Save</button></div>
          <div><button id="btnConnect" class="secondary" style="margin-top:1.7rem;">Connect</button></div>
        </div>
        <div style="margin-top:.6rem; display:flex; gap:.5rem; align-items:center;">
          <button id="btnClearKey" class="btn-ghost">Clear key</button>
          <span class="muted">Shortcut: press <span class="mono">g</span> then <span class="mono">o</span> to toggle Owner panel.</span>
        </div>
      </div>
    </section>

    <!-- Metrics grid -->
    <section class="grid-3" style="margin-top:1rem;">
      <article class="panel">
        <header class="muted">pH</header>
        <div class="kpi"><div class="value" id="phValue">—</div><small id="phDelta"></small></div>
        <small class="muted" id="phLatest">latest: —</small>
        <canvas id="phChart" class="spark" aria-label="pH sparkline" role="img"></canvas>
      </article>

      <article class="panel">
        <header class="muted">TDS (ppm)</header>
        <div class="kpi"><div class="value" id="tdsValue">—</div><small id="tdsDelta"></small></div>
        <small class="muted" id="tdsLatest">latest: —</small>
        <canvas id="tdsChart" class="spark" aria-label="TDS sparkline" role="img"></canvas>
      </article>

      <article class="panel">
        <header class="muted">Water °C</header>
        <div class="kpi"><div class="value" id="waterValue">—</div><small>°C</small></div>
        <small class="muted" id="waterLatest">latest: —</small>
      </article>

      <article class="panel">
        <header class="muted">Air °C</header>
        <div class="kpi"><div class="value" id="airValue">—</div><small>°C</small></div>
        <small class="muted" id="airLatest">latest: —</small>
      </article>

      <article class="panel">
        <header class="muted">Humidity %</header>
        <div class="kpi"><div class="value" id="humValue">—</div><small>%</small></div>
        <small class="muted" id="humLatest">latest: —</small>
      </article>
    </section>

    <section class="panel" style="margin-top:1rem;">
      <h4 style="margin-bottom:.5rem;">Recent Cloud Samples</h4>
      <div class="table-wrap">
        <table id="samples" role="grid">
          <thead>
            <tr>
              <th>ts</th><th>sensor</th><th class="right">value</th><th>deviceId</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <small class="muted" id="rowCount">0 rows</small>
    </section>
  </main>

<script>
/* -------------------- small helpers -------------------- */
const $ = (sel) => document.querySelector(sel);
const fmt = {
  ph: (v) => isFinite(v) ? Number(v).toFixed(2) : '—',
  tdsppm: (v) => isFinite(v) ? Number(v).toFixed(0) : '—',
  tempC: (v) => isFinite(v) ? Number(v).toFixed(1) : '—',
  waterC: (v) => isFinite(v) ? Number(v).toFixed(1) : '—',
  humidity: (v) => isFinite(v) ? Number(v).toFixed(0) : '—',
  ts: (s) => {
    try { return new Date(s).toISOString().replace('T',' ').replace('Z',''); } catch { return s || '—'; }
  }
};
// normalize incoming sensor names → canonical UI keys
function canonSensor(s) {
  if (!s) return '';
  s = String(s).toLowerCase();
  const map = {
    tds: 'tdsppm', ec: 'tdsppm', conductivity: 'tdsppm',
    air: 'tempC', airc: 'tempC', tempc: 'tempC', temperature: 'tempC',
    water: 'waterC', watertemp: 'waterC', waterc: 'waterC',
    hum: 'humidity', rh: 'humidity'
  };
  return map[s] || s;
}
function parseNum(x) { const n = Number(x); return isFinite(n) ? n : NaN; }

/* -------------------- state -------------------- */
let auto = false, autoTimer = null;
let charts = { ph: null, tdsppm: null };

const els = {
  statusChip: $('#statusChip'),
  syncBadge: $('#syncBadge'),
  btnRefresh: $('#btnRefresh'),
  btnAuto: $('#btnAuto'),
  ownerToggle: $('#ownerToggle'),
  ownerPanel: $('#ownerPanel'),
  host: $('#host'),
  deviceId: $('#deviceId'),
  fnKey: $('#fnKey'),
  btnSave: $('#btnSave'),
  btnConnect: $('#btnConnect'),
  btnClearKey: $('#btnClearKey'),
  deviceIdText: $('#deviceIdText'),
  phValue: $('#phValue'), phDelta: $('#phDelta'), phLatest: $('#phLatest'),
  tdsValue: $('#tdsValue'), tdsDelta: $('#tdsDelta'), tdsLatest: $('#tdsLatest'),
  waterValue: $('#waterValue'), waterLatest: $('#waterLatest'),
  airValue: $('#airValue'), airLatest: $('#airLatest'),
  humValue: $('#humValue'), humLatest: $('#humLatest'),
  samplesBody: $('#samples tbody'),
  rowCount: $('#rowCount'),
  deviceLine: $('#deviceLine')
};

function loadCfg(){
  els.host.value = localStorage.getItem('areka_host') || '';
  els.deviceId.value = localStorage.getItem('areka_device') || 'pi5-greenhouse-01';
  els.fnKey.value = localStorage.getItem('areka_fnkey') || '';
  els.deviceIdText.textContent = els.deviceId.value || '—';
}
function saveCfg() {
  localStorage.setItem('areka_host', els.host.value.trim());
  localStorage.setItem('areka_device', els.deviceId.value.trim());
  if (els.fnKey.value.trim()) localStorage.setItem('areka_fnkey', els.fnKey.value.trim());
  els.deviceIdText.textContent = els.deviceId.value.trim();
}
function clearKey(){
  localStorage.removeItem('areka_fnkey');
  els.fnKey.value = '';
}

function setStatus(ok){
  els.statusChip.textContent = ok ? 'online' : 'offline';
  els.statusChip.classList.toggle('success', ok);
  els.statusChip.classList.toggle('danger', !ok);
}

function setSyncBadge(txt){
  els.syncBadge.textContent = txt;
}

/* -------------------- fetch & render -------------------- */
async function fetchProbes(top=200){
  const base = (localStorage.getItem('areka_host')||'').replace(/\/+$/,'');
  const device = localStorage.getItem('areka_device') || '';
  const code = localStorage.getItem('areka_fnkey') || '';
  if (!base || !device) throw new Error('Missing host/device');

  const url = `${base}/api/Probes?deviceId=${encodeURIComponent(device)}&top=${top}${code ? `&code=${encodeURIComponent(code)}` : ''}`;
  const res = await fetch(url, { cache:'no-store' });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const raw = await res.json();

  // Items sometimes come as {c:{...}}; normalize to plain rows
  const rows = (Array.isArray(raw) ? raw : []).map(x => x && x.c ? x.c : x).map(r => ({
    ts: r.ts || r.time || r.timestamp,
    sensor: canonSensor(r.sensor),
    value: parseNum(r.value ?? r.val),
    deviceId: r.deviceId || r.deviceid || r.device || ''
  })).filter(r => r.ts && r.sensor);

  // sort ascending by time (oldest → newest)
  rows.sort((a,b)=> new Date(a.ts) - new Date(b.ts));
  return rows;
}

function latestBySensor(rows){
  const map = {};
  for (const r of rows) {
    if (!map[r.sensor] || new Date(r.ts) > new Date(map[r.sensor].ts)) {
      map[r.sensor] = r;
    }
  }
  return map;
}

function renderTable(rows){
  const tbody = els.samplesBody;
  tbody.innerHTML = '';
  const limit = Math.min(rows.length, 400);
  for (let i = rows.length - 1; i >= rows.length - limit; i--){
    const r = rows[i]; if (!r) break;
    const tr = document.createElement('tr');
    const tdTs = document.createElement('td'); tdTs.textContent = fmt.ts(r.ts);
    const tdSe = document.createElement('td'); tdSe.textContent = r.sensor;
    const tdVa = document.createElement('td'); tdVa.className = 'right mono';
    tdVa.textContent = isFinite(r.value) ? r.value : '';
    const tdDe = document.createElement('td'); tdDe.textContent = r.deviceId || '';
    tr.append(tdTs, tdSe, tdVa, tdDe);
    tbody.appendChild(tr);
  }
  els.rowCount.textContent = `${limit} rows`;
}

function ensureChart(name, canvasId, color){
  const ctx = document.getElementById(canvasId).getContext('2d');
  if (charts[name]) return charts[name];
  charts[name] = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [{ data: [], borderColor: color, pointRadius: 0, tension:.3, borderWidth:2, fill:false }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display:false }, tooltip: { intersect:false, mode:'index' } },
      scales: { x: { display:false }, y: { display:false } }
    }
  });
  return charts[name];
}

function series(rows, key){
  return rows.filter(r => r.sensor === key && isFinite(r.value));
}

function deltaText(arr){
  if (arr.length < 2) return '';
  const a = arr[arr.length-2].value, b = arr[arr.length-1].value;
  const d = b - a;
  if (!isFinite(d) || d === 0) return '';
  const sign = d > 0 ? '+' : '−';
  const cls = d > 0 ? 'up' : 'down';
  return { text: `${sign}${Math.abs(d).toFixed(2)}`, cls };
}

function renderAll(rows){
  // table
  renderTable(rows);

  // latests
  const latest = latestBySensor(rows);

  const phArr = series(rows, 'ph');
  const tdsArr = series(rows, 'tdsppm');

  // pH
  const phLast = latest['ph'];
  els.phValue.textContent = phLast ? fmt.ph(phLast.value) : '—';
  els.phLatest.textContent = phLast ? `latest: ${fmt.ts(phLast.ts)}` : 'latest: —';
  const phChart = ensureChart('ph', 'phChart', '#60a5fa');
  phChart.data.labels = phArr.map(r=>r.ts);
  phChart.data.datasets[0].data = phArr.map(r=>r.value);
  phChart.update('none');
  const phD = deltaText(phArr);
  els.phDelta.textContent = phD ? phD.text : '';
  els.phDelta.style.color = phD ? (phD.cls==='up' ? 'var(--up)' : 'var(--down)') : 'inherit';

  // TDS
  const tdsLast = latest['tdsppm'];
  els.tdsValue.textContent = tdsLast ? fmt.tdsppm(tdsLast.value) : '—';
  els.tdsLatest.textContent = tdsLast ? `latest: ${fmt.ts(tdsLast.ts)}` : 'latest: —';
  const tdsChart = ensureChart('tdsppm', 'tdsChart', '#34d399');
  tdsChart.data.labels = tdsArr.map(r=>r.ts);
  tdsChart.data.datasets[0].data = tdsArr.map(r=>r.value);
  tdsChart.update('none');
  const tdsD = deltaText(tdsArr);
  els.tdsDelta.textContent = tdsD ? tdsD.text : '';
  els.tdsDelta.style.color = tdsD ? (tdsD.cls==='up' ? 'var(--up)' : 'var(--down)') : 'inherit';

  // Temps & humidity (single latest each)
  const water = latest['waterC'];
  els.waterValue.textContent = water ? fmt.waterC(water.value) : '—';
  els.waterLatest.textContent = water ? `latest: ${fmt.ts(water.ts)}` : 'latest: —';

  const air = latest['tempC'];
  els.airValue.textContent = air ? fmt.tempC(air.value) : '—';
  els.airLatest.textContent = air ? `latest: ${fmt.ts(air.ts)}` : 'latest: —';

  const hum = latest['humidity'];
  els.humValue.textContent = hum ? fmt.humidity(hum.value) : '—';
  els.humLatest.textContent = hum ? `latest: ${fmt.ts(hum.ts)}` : 'latest: —';
}

async function refresh(){
  try {
    setSyncBadge('syncing…');
    const rows = await fetchProbes(200);
    renderAll(rows);
    const now = new Date();
    setSyncBadge(`synced ${now.toTimeString().slice(0,8)}`);
    setStatus(true);
  } catch (err) {
    console.error(err);
    setStatus(false);
    setSyncBadge('error – Failed to fetch');
  }
}

function setAuto(on){
  auto = !!on;
  els.btnAuto.classList.toggle('secondary', auto);
  els.btnAuto.textContent = auto ? 'Auto-refresh 30s (on)' : 'Auto-refresh 30s';
  if (autoTimer) clearInterval(autoTimer);
  if (auto) autoTimer = setInterval(refresh, 30000);
}

/* -------------------- events -------------------- */
els.btnRefresh.addEventListener('click', refresh);
els.btnAuto.addEventListener('click', ()=> setAuto(!auto));
els.ownerToggle.addEventListener('click', ()=> els.ownerPanel.style.display = (els.ownerPanel.style.display==='none' ? 'block' : 'none'));
els.btnSave.addEventListener('click', ()=>{ saveCfg(); refresh(); });
els.btnConnect.addEventListener('click', refresh);
els.btnClearKey.addEventListener('click', clearKey);

// keyboard: g then o
let lastKeyTime = 0, lastKey = '';
window.addEventListener('keydown', (e)=>{
  const now = Date.now();
  if (now - lastKeyTime > 1200) { lastKey=''; }
  if (e.key.toLowerCase()==='g') { lastKey='g'; lastKeyTime=now; return; }
  if (e.key.toLowerCase()==='o' && lastKey==='g') {
    els.ownerPanel.style.display = (els.ownerPanel.style.display==='none' ? 'block' : 'none');
    lastKey='';
  }
});

/* -------------------- boot -------------------- */
loadCfg();
els.deviceLine.innerHTML = `Device <strong class="mono" id="deviceIdText">${els.deviceId.value || '—'}</strong>. Pulls securely from Azure Functions (key stays in your browser).`;
setAuto(false);
setStatus(false);
refresh();
</script>
</body>
</html>
