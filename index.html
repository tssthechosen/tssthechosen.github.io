<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>d3m3t3r ‚Äî Greenhouse Telemetry</title>
  <meta name="color-scheme" content="dark light" />
  <meta name="description" content="Live hydroponics telemetry and device health for the Areka greenhouse." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Ccircle cx=%2750%27 cy=%2750%27 r=%2738%27 fill=%27%2300c36a%27/%3E%3Cpath d=%27M50 18c12 9 18 19 18 30 0 14-10 26-18 34-8-8-18-20-18-34 0-11 6-21 18-30z%27 fill=%27%23007346%27/%3E%3C/svg%3E" />
  <style>
    :root {
      --bg: #0c0f12;
      --panel: #12161b;
      --muted: #8892a6;
      --text: #e6edf3;
      --brand: #00c36a;
      --brand-2: #4ae3a1;
      --warn: #ffa629;
      --bad: #ff5468;
      --good: #3bd671;
      --card: #0f1318;
      --border: #1b222b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #f7fafc; --panel: #ffffff; --card:#ffffff; --text:#0c1117; --muted:#5c677d; --border:#e8eef4; 
        --shadow: 0 10px 20px rgba(16,24,40,.08);
      }
    }
    * {box-sizing:border-box}
    html,body {margin:0;padding:0;background:var(--bg); color:var(--text); font: 16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
    a {color: var(--brand-2); text-decoration: none}
    a:hover {text-decoration: underline}
    .container {max-width:1100px;margin:0 auto;padding:28px}
    header {display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:26px}
    .brand {display:flex;gap:12px;align-items:center}
    .logo {width:36px;height:36px;display:grid;place-items:center;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2));box-shadow:var(--shadow)}
    h1 {margin:0;font-size: clamp(22px, 2.2vw, 28px);letter-spacing:.3px}
    .chip {font-size:12px;padding:4px 10px;border-radius:999px;background:#10161c;border:1px solid var(--border);color:var(--muted)}
    main {display:grid;gap:18px}
    .hero {background:linear-gradient(145deg, rgba(0,195,106,.06), rgba(0,0,0,0)); border:1px solid var(--border);border-radius:var(--radius); padding:20px}
    .hero h2 {margin:0 0 6px 0; font-size: clamp(20px,2vw,24px)}
    .hero p {margin:0;color:var(--muted)}
    .controls {display:flex;flex-wrap:wrap;gap:10px; align-items:center;margin-top:14px}
    button, input, select {
      background: var(--card); color:var(--text); border:1px solid var(--border);
      border-radius:10px; padding:9px 12px; font: inherit;
    }
    button {cursor:pointer}
    button.primary {background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#00110a; border:none; font-weight:600}
    button.ghost {background:transparent}
    .grid {display:grid; gap:16px; grid-template-columns: repeat(12,1fr)}
    .card {grid-column: span 12; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
    .card h3 {margin:0 0 2px 0; font-size: 14px; color:var(--muted); font-weight:600; letter-spacing:.3px}
    .big {font-size: clamp(26px, 4vw, 36px); font-weight: 800; letter-spacing:.3px; margin: 4px 0}
    .sub {color:var(--muted); font-size: 13px}
    .trend {font-size: 12px; font-weight:600}
    .good {color: var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .row {display:flex; align-items:center; justify-content:space-between; gap:16px}
    .spark {height:38px; width:100%; display:block}
    .half {grid-column: span 6}
    .third {grid-column: span 4}
    .panel {background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px}
    .owner {display:none}
    .owner.open {display:block}
    .muted {color: var(--muted)}
    footer {margin:26px 0 8px 0; color:var(--muted); font-size:13px}
    .kbd {font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; background:#0e141a;border:1px solid var(--border); padding:2px 6px; border-radius:6px; color:var(--muted); font-size:12px}
    @media (max-width: 860px){
      .half {grid-column: span 12}
      .third {grid-column: span 6}
    }
    @media (max-width: 560px){
      .third {grid-column: span 12}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">üåø</div>
        <div>
          <h1>d3m3t3r</h1>
          <div class="muted" style="font-size:12px;line-height:1.2">
            Areka greenhouse telemetry ‚Äì privacy first, owner-controlled.
          </div>
        </div>
      </div>
      <div class="row" style="gap:10px">
        <span id="status" class="chip">offline</span>
        <button id="btnOwner" class="ghost" title="Owner panel (store key locally)">‚öôÔ∏è Owner</button>
      </div>
    </header>

    <section class="hero">
      <h2>Greenhouse ¬∑ Live</h2>
      <p>Device <strong>pi5-greenhouse-01</strong>. Pulls securely from Azure Functions (key stays in your browser).</p>
      <div class="controls">
        <button id="btnRefresh" class="primary">Refresh</button>
        <span class="chip" id="lastSync">no data yet</span>
        <span class="chip">Auto-refresh <span id="autoEvery">30s</span></span>
      </div>

      <div id="ownerPanel" class="owner panel" style="margin-top:12px">
        <div class="row" style="gap:12px; flex-wrap:wrap">
          <div style="flex: 1 1 240px">
            <div class="muted" style="font-size:12px">Cloud Host</div>
            <input id="host" spellcheck="false" value="https://func-areka-hydro-sn-fzdja9egd8htaycm.switzerlandnorth-01.azurewebsites.net" />
          </div>
          <div style="flex: 1 1 240px">
            <div class="muted" style="font-size:12px">Device Id</div>
            <input id="device" spellcheck="false" value="pi5-greenhouse-01" />
          </div>
          <div style="flex: 1 1 320px">
            <div class="muted" style="font-size:12px">Function Key (stored only in this browser)</div>
            <input id="fnkey" spellcheck="false" placeholder="paste once ‚Üí stays local" />
          </div>
        </div>
        <div class="controls" style="margin-top:12px">
          <button id="btnSave" class="primary">Save</button>
          <button id="btnConnect">Connect</button>
          <button id="btnClear" class="ghost">Clear key</button>
          <span class="muted">Shortcut: press <span class="kbd">g</span> then <span class="kbd">o</span> to toggle Owner panel.</span>
        </div>
      </div>
    </section>

    <main class="grid">
      <article class="card third">
        <h3>pH</h3>
        <div class="big" id="ph-val">‚Äî</div>
        <div class="row">
          <div class="sub" id="ph-time">latest: ‚Äî</div>
          <div class="trend" id="ph-trend"></div>
        </div>
        <svg class="spark" id="ph-spark" viewBox="0 0 100 30" preserveAspectRatio="none"></svg>
      </article>

      <article class="card third">
        <h3>TDS (ppm)</h3>
        <div class="big" id="tds-val">‚Äî</div>
        <div class="row">
          <div class="sub" id="tds-time">latest: ‚Äî</div>
          <div class="trend" id="tds-trend"></div>
        </div>
        <svg class="spark" id="tds-spark" viewBox="0 0 100 30" preserveAspectRatio="none"></svg>
      </article>

      <article class="card third">
        <h3>Water ¬∞C</h3>
        <div class="big" id="water-val">‚Äî</div>
        <div class="row">
          <div class="sub" id="water-time">latest: ‚Äî</div>
          <div class="trend" id="water-trend"></div>
        </div>
        <svg class="spark" id="water-spark" viewBox="0 0 100 30" preserveAspectRatio="none"></svg>
      </article>

      <article class="card half">
        <h3>Air ¬∞C</h3>
        <div class="big" id="air-val">‚Äî</div>
        <div class="row">
          <div class="sub" id="air-time">latest: ‚Äî</div>
          <div class="trend" id="air-trend"></div>
        </div>
        <svg class="spark" id="air-spark" viewBox="0 0 100 30" preserveAspectRatio="none"></svg>
      </article>

      <article class="card half">
        <h3>Humidity %</h3>
        <div class="big" id="hum-val">‚Äî</div>
        <div class="row">
          <div class="sub" id="hum-time">latest: ‚Äî</div>
          <div class="trend" id="hum-trend"></div>
        </div>
        <svg class="spark" id="hum-spark" viewBox="0 0 100 30" preserveAspectRatio="none"></svg>
      </article>

      <article class="card" style="grid-column: span 12">
        <div class="row"><h3>Recent Cloud Samples</h3><span class="sub" id="count"></span></div>
        <div id="table" class="panel" style="overflow:auto;border-radius:12px;margin-top:10px">
          <table style="width:100%;border-collapse:collapse;min-width:640px">
            <thead>
              <tr style="text-align:left;font-size:12px;color:var(--muted)">
                <th style="padding:10px;border-bottom:1px solid var(--border)">ts</th>
                <th style="padding:10px;border-bottom:1px solid var(--border)">sensor</th>
                <th style="padding:10px;border-bottom:1px solid var(--border)">value</th>
                <th style="padding:10px;border-bottom:1px solid var(--border)">deviceId</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </article>
    </main>

    <footer>
      Built for the Areka greenhouse ‚Ä¢ d3m3t3r.me ‚Ä¢ Auto refresh every <span id="every">30s</span>. Your key never leaves your browser.
    </footer>
  </div>

  <script>
    // ‚Äî‚Äî‚Äî Settings (persisted locally) ‚Äî‚Äî‚Äî
    const S = {
      get host(){ return localStorage.getItem('demeter.host') || 'https://func-areka-hydro-sn-fzdja9egd8htaycm.switzerlandnorth-01.azurewebsites.net'; },
      set host(v){ localStorage.setItem('demeter.host', v.trim()); },
      get device(){ return localStorage.getItem('demeter.device') || 'pi5-greenhouse-01'; },
      set device(v){ localStorage.setItem('demeter.device', v.trim()); },
      get key(){ return localStorage.getItem('demeter.key') || ''; },
      set key(v){ v ? localStorage.setItem('demeter.key', v.trim()) : localStorage.removeItem('demeter.key'); }
    };

    // ‚Äî‚Äî‚Äî Helpers ‚Äî‚Äî‚Äî
    const $ = sel => document.querySelector(sel);
    const fmt = (n, d=2) => (n==null || isNaN(n)) ? '‚Äî' : Number(n).toFixed(d);
    const timeAgo = iso => {
      if(!iso) return '‚Äî';
      const t = new Date(iso).getTime();
      if(Number.isNaN(t)) return iso;
      const s = Math.max(0, (Date.now() - t)/1000);
      if(s<60) return `${Math.floor(s)}s ago`;
      const m = s/60; if(m<60) return `${Math.floor(m)}m ago`;
      const h = m/60; if(h<24) return `${Math.floor(h)}h ago`;
      const d = h/24; return `${Math.floor(d)}d ago`;
    };

    // üîß Canonicalize sensor keys so "tds" appears under the TDS (ppm) card
    function canonSensor(name){
      const l = (name||'').toString().toLowerCase();
      switch(l){
        case 'tds':
        case 'ec':
        case 'conductivity':
          return 'tdsppm';
        case 'water':
        case 'waterc':
        case 'watertemp':
          return 'waterC';
        case 'air':
        case 'airc':
        case 'tempc':
        case 'temperature':
          return 'tempC';
        case 'hum':
        case 'rh':
          return 'humidity';
        default:
          return name || 'unknown';
      }
    }

    const bySensor = (arr) => {
      const m = new Map();
      for(const it of arr){
        const c = it.c || it;
        const raw = c.sensor || c.type || 'unknown';
        const k = canonSensor(raw);              // üëà use canonical key
        (m.get(k) || m.set(k, []).get(k)).push(c);
      }
      for(const [k,v] of m) v.sort((a,b)=> new Date(b.ts)-new Date(a.ts));
      return m;
    };

    const spark = (el, values) => {
      if(!values || values.length<2){ el.innerHTML=''; return; }
      const w=100, h=30, pad=1;
      const min = Math.min(...values), max = Math.max(...values);
      const norm = v => max===min ? h/2 : h - ((v-min)/(max-min))*h;
      const step = (w-2*pad)/(values.length-1);
      let d='M '+pad+' '+norm(values[0]).toFixed(2);
      values.forEach((v,i)=>{
        if(i===0) return;
        d+=' L '+(pad+i*step).toFixed(2)+' '+norm(v).toFixed(2);
      });
      el.innerHTML = `<path d="${d}" fill="none" stroke="url(#g)" stroke-width="1.5"/>`
                    + `<defs><linearGradient id="g" x1="0" x2="1"><stop offset="0%" stop-color="${getComputedStyle(document.documentElement).getPropertyValue('--brand').trim()}"/><stop offset="100%" stop-color="${getComputedStyle(document.documentElement).getPropertyValue('--brand-2').trim()}"/></linearGradient></defs>`;
    };

    // ‚Äî‚Äî‚Äî DOM wires ‚Äî‚Äî‚Äî
    const els = {
      status: $('#status'),
      lastSync: $('#lastSync'),
      every: $('#every'), autoEvery: $('#autoEvery'),
      host: $('#host'), device: $('#device'), fnkey: $('#fnkey'),
      btnOwner: $('#btnOwner'), ownerPanel: $('#ownerPanel'),
      btnSave: $('#btnSave'), btnConnect: $('#btnConnect'), btnClear: $('#btnClear'),
      btnRefresh: $('#btnRefresh'),
      ph: { val:$('#ph-val'), time:$('#ph-time'), trend:$('#ph-trend'), spark:$('#ph-spark') },
      tds:{ val:$('#tds-val'), time:$('#tds-time'), trend:$('#tds-trend'), spark:$('#tds-spark') },
      water:{ val:$('#water-val'), time:$('#water-time'), trend:$('#water-trend'), spark:$('#water-spark') },
      air:{ val:$('#air-val'), time:$('#air-time'), trend:$('#air-trend'), spark:$('#air-spark') },
      hum:{ val:$('#hum-val'), time:$('#hum-time'), trend:$('#hum-trend'), spark:$('#hum-spark') },
      rows: $('#rows'), count: $('#count'),
    };

    // ‚Äî‚Äî‚Äî Init owner fields ‚Äî‚Äî‚Äî
    const loadFields = () => { els.host.value=S.host; els.device.value=S.device; els.fnkey.value=S.key; };
    loadFields();

    // ‚Äî‚Äî‚Äî Toggle owner panel ‚Äî‚Äî‚Äî
    let goCombo = '';
    document.addEventListener('keydown', (e) => {
      goCombo = (goCombo + e.key.toLowerCase()).slice(-2);
      if(goCombo === 'go'){ els.ownerPanel.classList.toggle('open'); goCombo=''; }
    });
    els.btnOwner.addEventListener('click', () => els.ownerPanel.classList.toggle('open'));

    // ‚Äî‚Äî‚Äî Save/Connect/Clear ‚Äî‚Äî‚Äî
    els.btnSave.addEventListener('click', () => {
      S.host = els.host.value; S.device = els.device.value; if(els.fnkey.value) S.key = els.fnkey.value;
      loadFields();
      alert('Saved to this browser.');
    });
    els.btnClear.addEventListener('click', () => {
      S.key=''; els.fnkey.value='';
      alert('Key cleared from this browser.');
    });
    els.btnConnect.addEventListener('click', async () => {
      await refresh();
    });
    els.btnRefresh.addEventListener('click', () => refresh());

    // ‚Äî‚Äî‚Äî Fetch from Cloud ‚Äî‚Äî‚Äî
    async function fetchCloud(top=120){
      if(!S.key){ throw new Error('No function key set'); }
      const url = new URL('/api/Probes', S.host);
      url.searchParams.set('deviceId', S.device);
      url.searchParams.set('top', String(top));
      url.searchParams.set('code', S.key);
      const r = await fetch(url.toString(), { cache:'no-store' });
      if(!r.ok) throw new Error('HTTP '+r.status);
      const data = await r.json();
      return Array.isArray(data) ? data : [];
    }

    // ‚Äî‚Äî‚Äî Render helpers ‚Äî‚Äî‚Äî
    function setStatus(ok){
      els.status.textContent = ok ? 'online' : 'offline';
      els.status.style.color = ok ? 'var(--bg)' : 'var(--text)';
      els.status.style.background = ok ? 'linear-gradient(135deg,var(--brand),var(--brand-2))' : '#10161c';
      els.status.style.border = ok ? 'none' : '1px solid var(--border)';
    }
    function renderLatest(map, key, target, unit='', dp=2){
      const arr = map.get(key) || [];
      const latest = arr[0], prev = arr[1];
      const v = latest?.value, p = prev?.value;
      target.val.textContent = unit ? `${fmt(v, dp)} ${unit}` : fmt(v, dp);
      target.time.textContent = latest ? `latest: ${new Date(latest.ts).toLocaleTimeString()} (${timeAgo(latest.ts)})` : 'latest: ‚Äî';
      if(v!=null && p!=null){
        const delta = v - p;
        const dir = delta>0 ? '‚ñ≤' : delta<0 ? '‚ñº' : '‚Ä¢';
        const cls = delta>0 ? 'good' : delta<0 ? 'bad' : '';
        target.trend.className = 'trend ' + cls;
        target.trend.textContent = `${dir} ${fmt(Math.abs(delta), dp)}`;
      }else{
        target.trend.className = 'trend'; target.trend.textContent='‚Äî';
      }
      const series = arr.slice(0, 32).map(x=>x.value).reverse();
      spark(target.spark, series);
    }
    function renderTable(list){
      els.count.textContent = `${list.length} rows`;
      const rows = list.slice(0, 50).map(row=>{
        const c=row.c||row;
        return `<tr>
          <td style="padding:10px;border-bottom:1px solid var(--border)">${c.ts}</td>
          <td style="padding:10px;border-bottom:1px solid var(--border)">${c.sensor}</td>
          <td style="padding:10px;border-bottom:1px solid var(--border)">${c.value}</td>
          <td style="padding:10px;border-bottom:1px solid var(--border)">${c.deviceId||''}</td>
        </tr>`;
      }).join('');
      els.rows.innerHTML = rows || `<tr><td colspan="4" class="muted" style="padding:12px">No data.</td></tr>`;
    }

    // ‚Äî‚Äî‚Äî Refresh flow ‚Äî‚Äî‚Äî
    async function refresh(){
      try{
        if(!S.key){ alert('Owner: paste your Function key in the panel and Save.'); return; }
        setStatus(false);
        els.lastSync.textContent = 'fetching‚Ä¶';
        const list = await fetchCloud(200);
        const map = bySensor(list);

        renderLatest(map, 'ph',       els.ph,    '',   2);
        renderLatest(map, 'tdsppm',   els.tds,   'ppm',0); // now populated via canonSensor()
        renderLatest(map, 'waterC',   els.water, '¬∞C', 1);
        renderLatest(map, 'tempC',    els.air,   '¬∞C', 1);
        renderLatest(map, 'humidity', els.hum,   '%',  0);

        renderTable(list);
        setStatus(true);
        els.lastSync.textContent = 'synced ' + new Date().toLocaleTimeString();
      }catch(err){
        console.error(err);
        setStatus(false);
        els.lastSync.textContent = 'error ‚Äì ' + (err.message || String(err));
      }
    }

    // ‚Äî‚Äî‚Äî Auto refresh (30s) ‚Äî‚Äî‚Äî
    const EVERY = 30_000;
    els.every.textContent = (EVERY/1000)+'s';
    els.autoEvery.textContent = (EVERY/1000)+'s';
    setInterval(() => { if(S.key) refresh(); }, EVERY);

    // Kick once if key already saved
    if(S.key){ refresh(); }
  </script>
</body>
</html>
