<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>d3m3t3r • Greenhouse Live</title>
  <meta name="color-scheme" content="dark light" />
  <link href="https://cdn.jsdelivr.net/npm/@picocss/pico@1.5.10/css/pico.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --card-bg: rgba(255,255,255,0.02);
      --muted: #9aa2b2;
      --up:#2dd4bf; --down:#f43f5e; --accent:#60a5fa; --accent2:#34d399;
    }
    body { background:#0b1220 }
    main.container { max-width: 1100px; }
    .chip { font-size:.75rem; padding:.25rem .6rem; border-radius:999px; background:var(--card-bg); border:1px solid rgba(255,255,255,.06) }
    .chip.success { color:#10b981; border-color: rgba(16,185,129,.35) }
    .chip.danger  { color:#f43f5e; border-color: rgba(244,63,94,.35) }
    .panel { background:var(--card-bg); border:1px solid rgba(255,255,255,.06); border-radius:.8rem; padding:1rem }
    .muted { color:var(--muted) }
    .row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap }
    .owner-grid { display:grid; gap:.75rem; grid-template-columns: 1.6fr 1fr 1.6fr auto auto; align-items:end }
    @media (max-width: 900px){ .owner-grid { grid-template-columns: 1fr } }
    .grid-3 { display:grid; gap:1rem; grid-template-columns:repeat(3,minmax(0,1fr)) }
    .grid-2 { display:grid; gap:1rem; grid-template-columns:repeat(2,minmax(0,1fr)) }
    @media (max-width: 1000px){ .grid-3 { grid-template-columns:1fr } .grid-2{ grid-template-columns:1fr } }
    .kpi { display:flex; align-items:baseline; gap:.5rem }
    .value { font-size:2.25rem; font-weight:800; letter-spacing:-.02em }
    .spark { height:140px }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace }
    .right { text-align:right }
    .table-wrap { overflow:auto; max-height:520px }
    .ghost { background:transparent; border:1px solid rgba(255,255,255,.08) }
  </style>
</head>
<body>
<main class="container">
  <header style="margin:.5rem 0 0">
    <hgroup>
      <h2 style="margin:.25rem 0">d3m3t3r</h2>
      <p class="muted">Areka greenhouse telemetry — privacy first, owner-controlled.</p>
    </hgroup>
  </header>

  <section class="panel">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:.3rem 0">Greenhouse • Live</h3>
      <div class="row">
        <span id="statusChip" class="chip">offline</span>
        <button id="ownerToggle" class="chip ghost" type="button">⚙ Owner</button>
      </div>
    </div>
    <p class="muted">Device <strong class="mono" id="deviceIdText">—</strong>. Pulls securely from Azure Functions (key stays in your browser).</p>
    <div class="row" style="margin:.2rem 0 .6rem">
      <button id="btnRefresh" class="secondary">Refresh</button>
      <span id="syncBadge" class="chip">error – Failed to fetch</span>
      <button id="btnAuto" class="ghost">Auto-refresh 30s</button>
    </div>

    <div id="ownerPanel" class="panel" style="display:none; margin-top:.75rem">
      <div class="owner-grid">
        <div>
          <label for="host">Cloud Host</label>
          <input id="host" type="url" placeholder="https://func-...azurewebsites.net">
        </div>
        <div>
          <label for="deviceId">Device Id</label>
          <input id="deviceId" type="text" placeholder="pi5-greenhouse-01">
        </div>
        <div>
          <label for="fnKey">Function Key (kept only in this browser)</label>
          <input id="fnKey" type="password" autocomplete="off">
        </div>
        <div><button id="btnSave" class="secondary" style="margin-top:1.6rem">Save</button></div>
        <div><button id="btnConnect" class="secondary" style="margin-top:1.6rem">Connect</button></div>
      </div>
      <div class="row" style="margin-top:.5rem">
        <button id="btnClearKey" class="ghost">Clear key</button>
        <small class="muted">Tip: press <span class="mono">g</span> then <span class="mono">o</span> to toggle Owner panel.</small>
      </div>
    </div>
  </section>

  <section class="grid-3" style="margin-top:1rem">
    <article class="panel">
      <header class="muted">pH</header>
      <div class="kpi"><div class="value" id="phValue">—</div><small id="phDelta"></small></div>
      <small class="muted" id="phLatest">latest: —</small>
      <canvas id="phChart" class="spark"></canvas>
    </article>

    <article class="panel">
      <header class="muted">TDS (ppm)</header>
      <div class="kpi"><div class="value" id="tdsValue">—</div><small id="tdsDelta"></small></div>
      <small class="muted" id="tdsLatest">latest: —</small>
      <canvas id="tdsChart" class="spark"></canvas>
    </article>

    <article class="panel">
      <header class="muted">Water °C</header>
      <div class="kpi"><div class="value" id="waterValue">—</div><small>°C</small></div>
      <small class="muted" id="waterLatest">latest: —</small>
    </article>

    <article class="panel">
      <header class="muted">Air °C</header>
      <div class="kpi"><div class="value" id="airValue">—</div><small>°C</small></div>
      <small class="muted" id="airLatest">latest: —</small>
    </article>

    <article class="panel">
      <header class="muted">Humidity %</header>
      <div class="kpi"><div class="value" id="humValue">—</div><small>%</small></div>
      <small class="muted" id="humLatest">latest: —</small>
    </article>
  </section>

  <section class="panel" style="margin-top:1rem">
    <h4 style="margin-bottom:.4rem">Recent Cloud Samples</h4>
    <div class="table-wrap">
      <table id="samples">
        <thead><tr><th>ts</th><th>sensor</th><th class="right">value</th><th>deviceId</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <small class="muted" id="rowCount">0 rows</small>
  </section>
</main>

<script>
/* ============ helpers & UI ============ */
const $ = (q)=>document.querySelector(q);
const els = {
  statusChip: $('#statusChip'), syncBadge: $('#syncBadge'),
  btnRefresh: $('#btnRefresh'), btnAuto: $('#btnAuto'),
  ownerToggle: $('#ownerToggle'), ownerPanel: $('#ownerPanel'),
  host: $('#host'), deviceId: $('#deviceId'), fnKey: $('#fnKey'),
  btnSave: $('#btnSave'), btnConnect: $('#btnConnect'), btnClearKey: $('#btnClearKey'),
  deviceIdText: $('#deviceIdText'),
  phValue: $('#phValue'), phDelta: $('#phDelta'), phLatest: $('#phLatest'),
  tdsValue: $('#tdsValue'), tdsDelta: $('#tdsDelta'), tdsLatest: $('#tdsLatest'),
  waterValue: $('#waterValue'), waterLatest: $('#waterLatest'),
  airValue: $('#airValue'), airLatest: $('#airLatest'),
  humValue: $('#humValue'), humLatest: $('#humLatest'),
  samplesBody: $('#samples tbody'), rowCount: $('#rowCount')
};
let auto=false, autoTimer=null, charts={ph:null, tdsppm:null};

function setStatus(ok){ els.statusChip.textContent = ok?'online':'offline'; els.statusChip.classList.toggle('success',ok); els.statusChip.classList.toggle('danger',!ok); }
function setSync(txt){ els.syncBadge.textContent = txt; }

/* ============ config ============ */
function loadCfg(){
  els.host.value     = localStorage.getItem('areka_host')   || '';
  els.deviceId.value = localStorage.getItem('areka_device') || 'pi5-greenhouse-01';
  els.fnKey.value    = localStorage.getItem('areka_fnkey')  || '';
  els.deviceIdText.textContent = els.deviceId.value || '—';
}
function saveCfg(){
  localStorage.setItem('areka_host', (els.host.value||'').trim());
  localStorage.setItem('areka_device', (els.deviceId.value||'').trim());
  if ((els.fnKey.value||'').trim()) localStorage.setItem('areka_fnkey', (els.fnKey.value||'').trim());
  els.deviceIdText.textContent = els.deviceId.value || '—';
}
function clearKey(){ localStorage.removeItem('areka_fnkey'); els.fnKey.value=''; }

/* ============ data & normalization ============ */
// Only change you needed: alias incoming sensor names so TDS shows up.
function canonSensor(s){
  if (!s) return '';
  s = (''+s).toLowerCase();
  const map = {
    tds:'tdsppm', ec:'tdsppm', conductivity:'tdsppm',
    air:'tempC', airc:'tempC', temperature:'tempC', tempc:'tempC',
    water:'waterC', waterc:'waterC', watertemp:'waterC',
    hum:'humidity', rh:'humidity'
  };
  return map[s] || s;
}
function parseNum(x){ const n = Number(x); return isFinite(n) ? n : NaN; }

async function fetchProbes(top=200){
  const base   = (localStorage.getItem('areka_host')||'').replace(/\/+$/,'');
  const device = localStorage.getItem('areka_device')||'';
  const code   = localStorage.getItem('areka_fnkey') || '';
  if (!base || !device) throw new Error('Missing host or device');

  const url = `${base}/api/Probes?deviceId=${encodeURIComponent(device)}&top=${top}${code?`&code=${encodeURIComponent(code)}`:''}`;
  const res = await fetch(url, {cache:'no-store'});
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const raw = await res.json();

  const rows = (Array.isArray(raw)?raw:[])
    .map(x => x && x.c ? x.c : x)
    .map(r => ({
      ts: r.ts || r.time || r.timestamp,
      sensor: canonSensor(r.sensor),
      value: parseNum(r.value ?? r.val),
      deviceId: r.deviceId || r.deviceid || r.device || ''
    }))
    .filter(r => r.ts && r.sensor);
  rows.sort((a,b)=> new Date(a.ts) - new Date(b.ts));
  return rows;
}

function latestBySensor(rows){
  const m={}; for (const r of rows){ if(!m[r.sensor] || new Date(r.ts)>new Date(m[r.sensor].ts)) m[r.sensor]=r; }
  return m;
}
function series(rows, key){ return rows.filter(r=> r.sensor===key && isFinite(r.value)); }
function deltaText(arr, digits=2){
  if (arr.length<2) return '';
  const a = arr[arr.length-2].value, b = arr[arr.length-1].value, d = b-a;
  if (!isFinite(d) || d===0) return '';
  return `${d>0?'+':'−'}${Math.abs(d).toFixed(digits)}`;
}

/* ============ rendering ============ */
function ensureChart(name, canvasId, color){
  const ctx = document.getElementById(canvasId).getContext('2d');
  if (charts[name]) return charts[name];
  charts[name] = new Chart(ctx, {
    type:'line',
    data:{ labels:[], datasets:[{ data:[], borderColor:color, pointRadius:0, borderWidth:2, tension:.3, fill:false }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}, tooltip:{intersect:false,mode:'index'}}, scales:{x:{display:false}, y:{display:false}} }
  });
  return charts[name];
}
function fmtTs(s){ try{ return new Date(s).toISOString().replace('T',' ').replace('Z',''); } catch { return s||'—'; } }

function renderTable(rows){
  const tbody = els.samplesBody; tbody.innerHTML='';
  const limit = Math.min(rows.length, 400);
  for (let i = rows.length-1; i >= rows.length-limit; i--){
    const r = rows[i]; if (!r) break;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${fmtTs(r.ts)}</td><td>${r.sensor}</td><td class="right mono">${isFinite(r.value)?r.value:''}</td><td>${r.deviceId||''}</td>`;
    tbody.appendChild(tr);
  }
  els.rowCount.textContent = `${limit} rows`;
}

function renderAll(rows){
  renderTable(rows);
  const latest = latestBySensor(rows);

  // pH
  const phArr = series(rows,'ph');
  const phLast = latest['ph'];
  $('#phValue').textContent = phLast ? Number(phLast.value).toFixed(2) : '—';
  $('#phLatest').textContent = phLast ? `latest: ${fmtTs(phLast.ts)}` : 'latest: —';
  const phChart = ensureChart('ph','phChart','#60a5fa');
  phChart.data.labels = phArr.map(r=>r.ts);
  phChart.data.datasets[0].data = phArr.map(r=>r.value);
  phChart.update('none');
  $('#phDelta').textContent = deltaText(phArr,2);

  // TDS — now fed by either "tds" or already-"tdsppm"
  const tdsArr = series(rows,'tdsppm');
  const tdsLast = latest['tdsppm'];
  $('#tdsValue').textContent = tdsLast ? Number(tdsLast.value).toFixed(0) : '—';
  $('#tdsLatest').textContent = tdsLast ? `latest: ${fmtTs(tdsLast.ts)}` : 'latest: —';
  const tdsChart = ensureChart('tdsppm','tdsChart','#34d399');
  tdsChart.data.labels = tdsArr.map(r=>r.ts);
  tdsChart.data.datasets[0].data = tdsArr.map(r=>r.value);
  tdsChart.update('none');
  $('#tdsDelta').textContent = deltaText(tdsArr,0);

  // Singles
  const water = latest['waterC']; $('#waterValue').textContent = water? Number(water.value).toFixed(1) : '—'; $('#waterLatest').textContent = water? `latest: ${fmtTs(water.ts)}` : 'latest: —';
  const air   = latest['tempC'];  $('#airValue').textContent   = air?   Number(air.value).toFixed(1)   : '—'; $('#airLatest').textContent   = air?   `latest: ${fmtTs(air.ts)}`   : 'latest: —';
  const hum   = latest['humidity'];$('#humValue').textContent   = hum?   Number(hum.value).toFixed(0)   : '—'; $('#humLatest').textContent   = hum?   `latest: ${fmtTs(hum.ts)}`   : 'latest: —';
}

/* ============ actions ============ */
async function refresh(){
  try {
    setSync('syncing…');
    const rows = await fetchProbes(200);
    renderAll(rows);
    setStatus(true);
    setSync(`synced ${new Date().toTimeString().slice(0,8)}`);
  } catch (e) {
    console.error(e);
    setStatus(false);
    setSync('error – Failed to fetch');
  }
}
function setAuto(on){
  auto=!!on; if (autoTimer) clearInterval(autoTimer);
  els.btnAuto.textContent = auto ? 'Auto-refresh 30s (on)' : 'Auto-refresh 30s';
  els.btnAuto.classList.toggle('secondary', auto);
  if (auto) autoTimer = setInterval(refresh, 30000);
}

/* ============ events ============ */
els.btnRefresh.addEventListener('click', refresh);
els.btnAuto.addEventListener('click', ()=> setAuto(!auto));
els.ownerToggle.addEventListener('click', ()=> els.ownerPanel.style.display = (els.ownerPanel.style.display==='none' ? 'block' : 'none'));
els.btnSave.addEventListener('click', ()=>{ saveCfg(); refresh(); });
els.btnConnect.addEventListener('click', refresh);
els.btnClearKey.addEventListener('click', clearKey);

// g then o shortcut
let lastKey='', lastTime=0;
window.addEventListener('keydown', (e)=>{
  const now=Date.now(); if (now-lastTime>1200) lastKey='';
  if (e.key.toLowerCase()==='g'){ lastKey='g'; lastTime=now; return; }
  if (e.key.toLowerCase()==='o' && lastKey==='g'){ els.ownerPanel.style.display = (els.ownerPanel.style.display==='none' ? 'block' : 'none'); lastKey=''; }
});

/* ============ boot ============ */
loadCfg(); setAuto(false); setStatus(false); refresh();
</script>
</body>
</html>
